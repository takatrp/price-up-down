<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>価格改定検討ツール r24</title>

<!-- Favicon -->
<link rel="icon" type="image/png" sizes="192x192" href="favicon192192.png">
<link rel="apple-touch-icon" sizes="192x192" href="favicon192192.png">
<link rel="shortcut icon" href="favicon192192.png">

<style>
  :root{--brand:#578899;--ink:#1f2937;--muted:#6b7280;--bg:#f7fafc;--ok:#10b981;--warn:#ef4444;--card:#fff;--grid:#e5e7eb;}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic","Meiryo",sans-serif;}
  .wrap{max-width:1100px;margin:0 auto;padding:12px}

  /* ヘッダー */
  .header{display:flex;align-items:center;gap:12px;margin:6px 0 8px}
  .logo{height:48px;width:auto;object-fit:contain;border-radius:8px}
  .title{font-weight:800;font-size:1.25rem;color:#0f172a;display:flex;align-items:center;gap:6px}
  .badge{display:inline-block;padding:3px 8px;border-radius:8px;background:#eef6fa;color:#578899;font-weight:700;font-size:.82rem}
  .headRight{margin-left:auto;display:flex;gap:6px;align-items:center}
  .sub{font-size:.85rem;color:var(--muted);margin:0 0 8px}

  /* カード */
  .card{background:var(--card);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:12px}
  .pill{display:inline-block;background:rgba(87,136,153,.1);color:var(--brand);font-weight:700;border-radius:999px;padding:5px 9px;font-size:.8rem}
  .cardHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}

  /* 入力 */
  label{display:block;font-size:.86rem;color:#374151;margin:6px 0 6px;font-weight:600}
  input[type="text"],textarea{width:100%;box-sizing:border-box;border:1px solid #e5e7eb;border-radius:10px;padding:10px;font-size:1rem;background:#fff;outline:none}
  input:focus,textarea:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(87,136,153,.15)}
  .primaryInput{border:2px solid var(--brand)!important;background:#f3f8fb}
  input::placeholder{color:#c7ccd3} /* 例）を薄く */
  .hint{font-size:.76rem;color:var(--muted);margin-top:4px}

  /* ボタン／チップ */
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;background:var(--brand);color:#fff;border:none;border-radius:10px;padding:10px 12px;font-weight:700;font-size:.92rem;cursor:pointer}
  .btn.alt{background:#e5e7eb;color:#111827}
  .btn.ghost{background:transparent;color:#374151;border:1px solid #d1d5db}
  .btn.sm{padding:6px 8px;font-size:.82rem;border-radius:8px}
  .miniActions{display:flex;gap:6px}

  .chipGroup{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px;margin-bottom:2px}
  .chip{border:1px solid #d1d5db;background:#fff;border-radius:999px;padding:6px 10px;font-size:.85rem;font-weight:700;color:#374151;cursor:pointer}
  .chip.active{border-color:var(--brand);background:#eef6fa;color:#0f172a}

  /* スライダー */
  .slider{display:flex;align-items:center;gap:8px;margin-top:6px}
  input[type="range"]{width:100%}

  /* STEP1クイック表示 */
  .inlineStats{display:flex;gap:12px;flex-wrap:wrap;margin-top:6px}
  .stat{font-size:.9rem;color:#374151;background:#f0f4f8;border:1px solid #e5e7eb;padding:6px 10px;border-radius:8px}
  .hide{display:none}

  /* KPI/カード */
  .kpi{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
  .kpi .item{flex:1 1 160px;min-width:160px;background:#fff;border:1px solid #eef2f7;border-radius:10px;padding:10px}
  .kpi .lbl{font-size:.76rem;color:#6b7280}
  .kpi .val{font-size:1.2rem;font-weight:800;margin-top:2px}
  .kpi .sub{font-size:.78rem;color:#6b7280;margin-top:2px}
  .danger{color:var(--warn);font-weight:700;margin-top:8px}

  /* サブカード（改定後＋現状比） */
  .subgrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;margin-top:6px}
  .subcard{border:1px solid #eef2f7;border-radius:10px;padding:10px;background:#fff}
  .subttl{font-size:.82rem;color:#6b7280;font-weight:700;margin-bottom:6px}
  .bigVal{font-size:1.25rem;font-weight:800}
  .delta{font-size:.82rem;color:#6b7280;margin-top:4px}

  /* グラフ */
  .chartWrap{display:flex;flex-direction:column;gap:8px}
  .chart{width:100%;height:116px;border:1px solid var(--grid);border-radius:10px;padding:8px;box-sizing:border-box}
  svg{width:100%;height:100%}
  .legend{display:flex;gap:8px;align-items:center;font-size:.82rem;color:#374151;margin-top:4px}
  .lg{display:inline-block;width:14px;height:10px;border-radius:3px}
  .lg.cur{background:var(--brand)} .lg.req.ok{background:#10b981} .lg.req.warn{background:#ef4444}

  /* レイアウト：デフォ1カラム／横向きは2カラム */
  .dashboard{display:block}
  .colL,.colR{display:flex;flex-direction:column;gap:10px}
  @media (orientation:landscape){
    .dashboard{display:grid;grid-template-columns:minmax(300px,42%) 1fr;gap:10px;align-items:start}
  }
  @media (min-width:1024px){
    .dashboard{display:grid;grid-template-columns:380px 1fr;gap:10px;align-items:start}
  }

  /* ミニフッター（ポータル仕様） */
  .mk-mini{
    margin:16px auto 10px;
    max-width:1100px;
    color:#374151;
    font-size:.84rem;
    text-align:center;
  }
  .mk-mini a{color:inherit;text-decoration:underline}
  .note{font-size:.8rem;color:#6b7280;text-align:center;margin-bottom:24px}
  @media print{.slider input[type="range"],button{display:none !important}.wrap{max-width:900px}}

  /* ===== チュートリアル（ガイド） ===== */
  .tour-overlay{position:fixed;inset:0;background:rgba(15,23,42,.45);backdrop-filter:saturate(120%) blur(1px);z-index:9998;display:none}
  .tour-overlay.active{display:block}
  .tour-spot{position:fixed;border:2px solid #fff;border-radius:12px;box-shadow:0 0 0 8px rgba(255,255,255,.18),0 10px 30px rgba(0,0,0,.35);z-index:9999;pointer-events:none;transition:all .18s ease}
  .tour-box{position:fixed;max-width:380px;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:14px;z-index:10000}
  .tour-title{font-weight:800;margin:2px 0 4px;color:#0f172a}
  .tour-text{font-size:.92rem;color:#374151;line-height:1.55}
  .tour-controls{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
  .tour-step{font-size:.8rem;color:#6b7280}
  .tour-actions{display:flex;gap:6px;align-items:center}
  .tour-btn{padding:6px 10px;border-radius:8px;font-weight:700;font-size:.85rem;border:1px solid #d1d5db;background:#fff;color:#111827;cursor:pointer}
  .tour-btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .tour-btn.ghost{background:transparent}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <a href="https://www.matsumoto-kaikei.or.jp/" target="_blank" rel="noopener noreferrer">
      <img src="ロゴ.jpg" alt="ロゴ" class="logo">
    </a>
    <div class="title">価格改定検討ツール <span class="badge">r24</span></div>
    <div class="headRight">
      <button id="helpBtn" class="btn ghost sm" type="button" aria-label="チュートリアルを開始">❓ チュートリアル</button>
    </div>
  </div>
  <div class="sub">値引き/値上げの「現場インパクト」を<b>限界利益</b>で数値化＆グラフ化。</div>

  <div class="dashboard">
    <!-- 左 -->
    <div class="colL">
      <div class="card step1" id="step1Card">
        <div class="cardHeader">
          <div class="pill">STEP 1：現状を入力</div>
          <div class="miniActions">
            <button class="btn alt sm" id="sampleBtn" type="button">サンプル読込</button>
            <button class="btn alt sm" id="resetBtn" type="button">リセット</button>
          </div>
        </div>

        <label for="price">現在の単価（税抜）</label>
        <input type="text" id="price" class="primaryInput" inputmode="decimal" placeholder="例）1,200" />

        <div class="chipGroup" aria-label="コスト入力方法" id="chipsCostGroup">
          <button class="chip active" id="chipCost" type="button">原価（変動費）</button>
          <button class="chip" id="chipMrate" type="button">限界利益率</button>
        </div>
        <div id="blockCost">
          <label for="cost">1単位あたり原価（変動費）</label>
          <div class="slider">
            <input type="range" id="costRange" min="0" max="100000" step="1" />
            <input type="text" id="cost" inputmode="decimal" placeholder="例）720" />
          </div>
        </div>
        <div id="blockMrate" class="hide">
          <label for="mrate">限界利益率（%）</label>
          <div class="slider">
            <input type="range" id="mrateRange" min="0" max="90" step="0.1" />
            <input type="text" id="mrate" inputmode="decimal" placeholder="例）40" />
            <span class="hint">%</span>
          </div>
        </div>

        <div class="chipGroup" aria-label="ボリューム入力方法" id="chipsVolGroup">
          <button class="chip active" id="chipQty" type="button">数量</button>
          <button class="chip" id="chipRev" type="button">売上高</button>
        </div>
        <div id="blockQty">
          <label for="qty">月間販売数量（単位）</label>
          <div class="slider">
            <input type="range" id="qtyRange" min="0" max="10000" step="1" />
            <input type="text" id="qty" inputmode="numeric" placeholder="例）1,000" />
          </div>
        </div>
        <div id="blockRev" class="hide">
          <label for="revenue">月間売上高（税抜）</label>
          <div class="slider">
            <input type="range" id="revRange" min="0" max="3000000" step="1000" />
            <input type="text" id="revenue" inputmode="decimal" placeholder="例）1,200,000" />
          </div>
        </div>

        <div class="hint">※固定費は扱いません（「同じ限界利益額を維持するために必要な売上/数量」を算出）。</div>

        <!-- クイック表示 -->
        <div class="inlineStats" id="inlineStats">
          <div class="stat hide" id="statM">限界利益率：<span id="stat_m_val">—</span></div>
          <div class="stat hide" id="statT">限界利益額：<span id="stat_t_val">—</span></div>
          <div class="stat hide" id="statR">売上高：<span id="stat_r_val">—</span></div>
        </div>
      </div>

      <div class="card step2" id="step2Card">
        <div class="pill">STEP 2：値改定を設定</div>

        <div class="chipGroup" aria-label="改定方法の選択" id="chipsChgGroup">
          <button class="chip active" id="chipRate" type="button" aria-selected="true">値改定率</button>
          <button class="chip" id="chipAbs" type="button" aria-selected="false">改定後単価</button>
        </div>

        <div id="rateInputs">
          <label for="chgPct">値改定率（%） <span class="hint">マイナス=値引き、プラス=値上げ</span></label>
          <div class="slider">
            <input type="range" id="chgRange" min="-70" max="70" step="0.1" value="0" />
            <input type="text" id="chgPct" style="width:120px" inputmode="text" value="0" />
            <span class="hint">%</span>
          </div>
        </div>

        <div id="absInputs" class="hide">
          <label for="chgAbs">改定後単価（税抜）</label>
          <div class="slider">
            <input type="range" id="chgAbsRange" min="0" max="200000" step="1" />
            <input type="text" id="chgAbs" inputmode="decimal" placeholder="例）1,140" />
          </div>
        </div>

        <div class="hint" style="margin-top:6px">安全域インジケータ（値引き率が −m を超えると原価割れ）</div>
        <div style="height:8px;border-radius:999px;background:#e5e7eb;overflow:hidden"><span id="safetyBar" style="display:block;height:100%;background:linear-gradient(90deg,var(--warn),#f59e0b,var(--ok));width:0%"></span></div>
      </div>

      <div class="card actions" id="actionsCard">
        <div class="pill">今日やる3アクション</div>
        <ol id="actions" style="margin-top:6px;padding-left:20px"></ol>
      </div>
    </div>

    <!-- 右 -->
    <div class="colR">
      <div class="card result" id="resultCard">
        <div class="pill">結果</div>

        <!-- 改定後単価 + 改定後売上高 -->
        <div class="kpi" style="margin-top:6px">
          <div class="item">
            <div class="lbl">改定後単価</div>
            <div class="val" id="kpi_price2">—</div>
          </div>
          <div class="item">
            <div class="lbl">改定後売上高</div>
            <div class="val" id="kpi_rev2">—</div>
            <div class="sub" id="kpi_rev2diff">現状比 —</div>
          </div>
        </div>

        <!-- 改定後＋現状比 -->
        <div class="subgrid">
          <div class="subcard">
            <div class="subttl">限界利益率</div>
            <div class="bigVal" id="kpi_m2">—</div>
            <div class="delta" id="delta_m">現状比 —</div>
          </div>
          <div class="subcard">
            <div class="subttl">限界利益額</div>
            <div class="bigVal" id="kpi_T2">—</div>
            <div class="delta" id="delta_T">現状比 —</div>
          </div>
        </div>

        <!-- 同じ限界利益額を維持するための必要指標 -->
        <div class="kpi">
          <div class="item">
            <div class="lbl">同じ限界利益額を維持するための必要売上</div>
            <div class="val" id="kpi_reqRev">—</div>
            <div class="hint" id="kpi_reqRevDiff"></div>
          </div>
          <div class="item">
            <div class="lbl">同じ限界利益額を維持するための必要数量</div>
            <div class="val" id="kpi_reqQty">—</div>
            <div class="hint" id="kpi_reqQtyDiff"></div>
          </div>
        </div>

        <div id="dangerMsg" class="danger hide"></div>
      </div>

      <div class="card graph" id="graphCard">
        <div class="pill">グラフで確認</div>
        <div class="chartWrap">
          <div>
            <div class="hint">売上：現状 vs 必要（同じ限界利益額を維持）</div>
            <div class="chart"><svg id="revChart" viewBox="0 0 360 116" preserveAspectRatio="none"></svg></div>
            <div class="legend">
              <span class="lg cur"></span>現状
              <span class="lg req ok" id="lgRevOk" style="display:none"></span><span id="lgRevOkLbl" style="display:none">必要（下降＝楽）</span>
              <span class="lg req warn" id="lgRevWarn" style="display:none"></span><span id="lgRevWarnLbl" style="display:none">必要（上昇＝厳）</span>
            </div>
          </div>
          <div>
            <div class="hint">数量：現状 vs 必要（同じ限界利益額を維持）</div>
            <div class="chart"><svg id="qtyChart" viewBox="0 0 360 116" preserveAspectRatio="none"></svg></div>
            <div class="legend">
              <span class="lg cur"></span>現状
              <span class="lg req ok" id="lgQtyOk" style="display:none"></span><span id="lgQtyOkLbl" style="display:none">必要（下降＝楽）</span>
              <span class="lg req warn" id="lgQtyWarn" style="display:none"></span><span id="lgQtyWarnLbl" style="display:none">必要（上昇＝厳）</span>
            </div>
          </div>
        </div>
      </div>

      <div class="card sens" id="sensCard">
        <div class="pill">感度（±1/±5/±10% の値改定時）</div>
        <div class="hint">「現状と同じ限界利益額を維持するために必要な売上/数量（比較）」</div>
        <div style="overflow:auto">
          <table class="table" id="sensTable">
            <thead><tr><th>改定率</th><th>必要売上</th><th>現状比</th><th>必要数量</th><th>現状比</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card template" id="templateCard">
        <div class="pill">顧客向け告知テンプレ（メール/店頭/見積書注記）</div>
        <textarea class="area" id="templateArea" style="min-height:180px"></textarea>
        <div class="miniActions" style="margin-top:8px">
          <button class="btn" id="copyResultBtn" type="button">結果をコピー</button>
          <button class="btn" id="copyTemplateBtn" type="button">テンプレをコピー</button>
          <button class="btn alt" id="printBtn" type="button">印刷</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ▼ ツールポータル仕様のミニフッター（CC/TASL準拠） -->
<footer class="mk-mini">
  © <span id="cpy-year">2025</span> <a href="https://www.matsumoto-kaikei.or.jp/" target="_blank" rel="noopener license">税理士法人松本会計事務所</a> ｜ 
  <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="license noopener">CC BY-NC-SA 4.0</a> ｜ 
  <a href="/tool-portal/terms.html" target="_blank" rel="noopener">利用条件</a> ｜ 
  <span id="build-rev">r24</span>（<span id="last-updated-date"></span>）
</footer>
<div class="note">本ツールは管理会計上の試算です。実際の価格変更は取引条件・競合状況・需要弾力性等も併せてご判断ください。</div>

<!-- ===== チュートリアル（DOM要素） ===== -->
<div id="tourOverlay" class="tour-overlay" aria-hidden="true">
  <div id="tourSpot" class="tour-spot"></div>
  <div id="tourBox" class="tour-box" role="dialog" aria-modal="true" aria-live="polite">
    <div class="tour-title" id="tourTitle">ようこそ</div>
    <div class="tour-text" id="tourText"></div>
    <div class="tour-controls">
      <div class="tour-step" id="tourStep">1 / 1</div>
      <div class="tour-actions">
        <button class="tour-btn ghost" id="tourDemoBtn" type="button">デモ入力</button>
        <button class="tour-btn" id="tourBack" type="button">戻る</button>
        <button class="tour-btn primary" id="tourNext" type="button">次へ</button>
        <button class="tour-btn ghost" id="tourEnd" type="button" aria-label="終了">終了</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  /* ================== 共通ユーティリティ ================== */
  const yen = n => isFinite(n) ? new Intl.NumberFormat('ja-JP',{style:'currency',currency:'JPY',maximumFractionDigits:0}).format(n) : '—';
  const pct = x => isFinite(x) ? (x*100).toFixed(1).replace(/\.0$/,'') + '%' : '—';
  const toNum=v=>{const s=String(v||'').replace(/,/g,'').replace(/[^\d.-]/g,'');const n=parseFloat(s);return isFinite(n)?n:NaN;}
  const clamp=(v,min,max)=>Math.min(max,Math.max(min,v));
  const comma=(el,dec=null)=>{const n=toNum(el.value);if(!isFinite(n))return;
    if(dec===0)el.value=Math.round(n).toLocaleString('ja-JP');
    else if(typeof dec==='number')el.value=n.toLocaleString('ja-JP',{minimumFractionDigits:dec,maximumFractionDigits:dec});
    else{const raw=String(el.value).replace(/,/g,'');const hasDot=raw.includes('.');el.value=hasDot?n.toLocaleString('ja-JP',{maximumFractionDigits:6}):Math.round(n).toLocaleString('ja-JP');}
  };

  let costMode='cost', volMode='qty', chgMode='rate';

  /* ================== 要素 ================== */
  const price = document.getElementById('price');
  const chipCost=document.getElementById('chipCost'), chipMrate=document.getElementById('chipMrate');
  const chipQty=document.getElementById('chipQty'), chipRev=document.getElementById('chipRev');
  const chipRate=document.getElementById('chipRate'), chipAbs=document.getElementById('chipAbs');

  const blockCost=document.getElementById('blockCost'), blockMrate=document.getElementById('blockMrate');
  const blockQty=document.getElementById('blockQty'), blockRev=document.getElementById('blockRev');

  const cost=document.getElementById('cost'), costRange=document.getElementById('costRange');
  const mrate=document.getElementById('mrate'), mrateRange=document.getElementById('mrateRange');

  const qty=document.getElementById('qty'), qtyRange=document.getElementById('qtyRange');
  const revenue=document.getElementById('revenue'), revRange=document.getElementById('revRange');

  const chgRange=document.getElementById('chgRange'), chgPct=document.getElementById('chgPct');
  const chgAbs=document.getElementById('chgAbs'), chgAbsRange=document.getElementById('chgAbsRange');

  const safetyBar=document.getElementById('safetyBar');

  const kpi_price2=document.getElementById('kpi_price2');
  const kpi_rev2=document.getElementById('kpi_rev2');
  const kpi_rev2diff=document.getElementById('kpi_rev2diff');

  const kpi_m2=document.getElementById('kpi_m2');
  const kpi_T2=document.getElementById('kpi_T2');
  const delta_m=document.getElementById('delta_m');
  const delta_T=document.getElementById('delta_T');

  const kpi_reqRev=document.getElementById('kpi_reqRev');
  const kpi_reqRevDiff=document.getElementById('kpi_reqRevDiff');
  const kpi_reqQty=document.getElementById('kpi_reqQty');
  const kpi_reqQtyDiff=document.getElementById('kpi_reqQtyDiff');

  const dangerMsg=document.getElementById('dangerMsg');
  const sensBody=document.querySelector('#sensTable tbody');
  const actions=document.getElementById('actions');
  const templateArea=document.getElementById('templateArea');
  const actionsCard=document.getElementById('actionsCard');
  const sensCard=document.getElementById('sensCard');

  const statM=document.getElementById('statM'), statT=document.getElementById('statT'), statR=document.getElementById('statR');
  const stat_m_val=document.getElementById('stat_m_val'), stat_t_val=document.getElementById('stat_t_val'), stat_r_val=document.getElementById('stat_r_val');

  const revChart=document.getElementById('revChart');
  const qtyChart=document.getElementById('qtyChart');
  const lgRevOk=document.getElementById('lgRevOk');
  const lgRevOkLbl=document.getElementById('lgRevOkLbl');
  const lgRevWarn=document.getElementById('lgRevWarn');
  const lgRevWarnLbl=document.getElementById('lgRevWarnLbl');
  const lgQtyOk=document.getElementById('lgQtyOk');
  const lgQtyOkLbl=document.getElementById('lgQtyOkLbl');
  const lgQtyWarn=document.getElementById('lgQtyWarn');
  const lgQtyWarnLbl=document.getElementById('lgQtyWarnLbl');

  /* ================== レイアウト（スマホ横で2カラム） ================== */
  function isTwoCol(){
    return window.matchMedia('(min-width:1024px)').matches
        || window.matchMedia('(orientation:landscape)').matches;
  }
  function relocateActions(){
    if(isTwoCol()){
      const step2=document.querySelector('.step2');
      if(actionsCard.previousElementSibling!==step2){ step2.insertAdjacentElement('afterend',actionsCard); }
    }else{
      if(actionsCard.previousElementSibling!==sensCard){ sensCard.insertAdjacentElement('afterend',actionsCard); }
    }
  }
  window.addEventListener('resize', ()=>{relocateActions(); compute();});

  /* ================== 範囲設定 ================== */
  function updateRanges(){
    const P=toNum(price.value);
    const priceOk=isFinite(P)&&P>0;

    costRange.min=0; costRange.max=priceOk?Math.floor(P):100000; costRange.step=1;
    qtyRange.min=0; qtyRange.max=10000; qtyRange.step=1;
    revRange.min=0; revRange.max=priceOk?Math.ceil(P*10000):3000000; revRange.step=1000;
    chgRange.min=-70; chgRange.max=70; chgRange.step=0.1;

    const absMax=priceOk?Math.ceil(P*2):200000;
    chgAbsRange.min=0; chgAbsRange.max=absMax; chgAbsRange.step=1;

    const clampIO=(rangeEl,inputEl,dec=null)=>{
      const v=toNum(inputEl.value);
      if(isFinite(v)){
        const cl=clamp(v, Number(rangeEl.min), Number(rangeEl.max));
        if (cl!==v){ inputEl.value=dec===0?Math.round(cl).toLocaleString('ja-JP'):cl.toLocaleString('ja-JP'); }
        rangeEl.value=cl;
      }
      if(dec!==null) comma(inputEl,dec); else comma(inputEl);
    };
    clampIO(costRange,cost);
    clampIO(qtyRange,qty,0);
    clampIO(revRange,revenue);
  }

  /* ================== SVGチャート ================== */
  function clearSVG(svg){while(svg.firstChild)svg.removeChild(svg.firstChild);}
  function drawPairBar(svg,cur,req,isRev){
    if(!isFinite(cur)){ clearSVG(svg); return; }
    if(!isFinite(req)) req = cur;
    clearSVG(svg);
    const vb=(svg.getAttribute('viewBox')||'0 0 360 116').split(' ').map(Number);
    const W=vb[2];
    const barH=18,gap=12,left=64,right=120;
    const maxVal=Math.max(cur,req)*1.15||1;
    const scale=(W-left-right)/maxVal;
    const y1=24,y2=y1+barH+gap;

    const mk=(x1,y1,x2,y2,s='#e5e7eb')=>{const l=document.createElementNS('http://www.w3.org/2000/svg','line');l.setAttribute('x1',x1);l.setAttribute('y1',y1);l.setAttribute('x2',x2);l.setAttribute('y2',y2);l.setAttribute('stroke',s);l.setAttribute('stroke-width','1');svg.appendChild(l);};
    mk(left,y1-12,left,y2+barH+10);
    [0.25,0.5,0.75,1].forEach(p=>{const xx=left+(W-left-right)*p;mk(xx,y1-12,xx,y2+barH+10);});

    const txt=(x,y,t,a='end')=>{const tx=document.createElementNS('http://www.w3.org/2000/svg','text');tx.setAttribute('x',x);tx.setAttribute('y',y);tx.setAttribute('fill','#374151');tx.setAttribute('font-size','12');tx.setAttribute('text-anchor',a);tx.textContent=t;svg.appendChild(tx);};
    txt(left-10,y1+barH-5,'現状'); txt(left-10,y2+barH-5,'必要');

    const rect=(x,y,w,h,fill)=>{const r=document.createElementNS('http://www.w3.org/2000/svg','rect');r.setAttribute('x',x);r.setAttribute('y',y);r.setAttribute('width',w);r.setAttribute('height',h);r.setAttribute('rx','6');r.setAttribute('fill',fill);svg.appendChild(r);};
    const wCur=Math.max(2,cur*scale), wReq=Math.max(2,req*scale), up=req>cur;
    rect(left,y1,wCur,barH,'var(--brand)');
    rect(left,y2,wReq,barH, up?'var(--warn)':'var(--ok)');

    const rightX=W-8;
    const fmt=isRev?(v)=>yen(v):(v)=>(Math.round(v*100)/100).toLocaleString('ja-JP')+' 単位';
    txt(rightX,y1+barH-5,fmt(cur),'end');
    txt(rightX,y2+barH-5,fmt(req),'end');

    if(isRev){lgRevOk.style.display=up?'none':'inline-block';lgRevOkLbl.style.display=up?'none':'inline';lgRevWarn.style.display=up?'inline-block':'none';lgRevWarnLbl.style.display=up?'inline':'none';}
    else{lgQtyOk.style.display=up?'none':'inline-block';lgQtyOkLbl.style.display=up?'none':'inline';lgQtyWarn.style.display=up?'inline-block':'none';lgQtyWarnLbl.style.display=up?'inline':'none';}
  }

  /* ================== インジケータ・感度 ================== */
  function safetyGauge(m,r){
    if(!isFinite(m)||!isFinite(r)){safetyBar.style.width='0%';return;}
    const x=(r-(-m))/(0.3-(-m)); safetyBar.style.width=Math.min(100,Math.max(0,x*100)).toFixed(1)+'%';
  }
  function buildSensitivity(base,steps){
    const {P,C,Q,R0}=base, T0=(P-C)*Q; sensBody.innerHTML='';
    steps.forEach(s=>{
      const r=s/100, P2=P*(1+r), CM2=P2-C;
      let Qreq=NaN, Rreq=NaN, rr=NaN, rq=NaN;
      if(CM2>0){ Qreq=T0/CM2; Rreq=P2*Qreq; rr=R0>0?(Rreq/R0-1):NaN; rq=Q>0?(Qreq/Q-1):NaN; }
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${s>0?'+':''}${s}%</td>
        <td>${isFinite(Rreq)?yen(Rreq):'—'}</td>
        <td>${isFinite(rr)?(rr>=0?'+':'')+(rr*100).toFixed(1)+'%':'—'}</td>
        <td>${isFinite(Qreq)?(Math.round(Qreq*100)/100).toLocaleString('ja-JP')+' 単位':'—'}</td>
        <td>${isFinite(rq)?(rq>=0?'+':'')+(rq*100).toFixed(1)+'%':'—'}</td>`;
      sensBody.appendChild(tr);
    });
  }

  /* ================== テンプレ（厚め） ================== */
  function buildTemplate({r,P,P2,R0,Rreq,Q,Qreq,m,m2,T0,T2}){
    if(![r,P,P2,Q].every(x=>isFinite(x))){ templateArea.value=''; return; }
    const rPct=(r*100).toFixed(1);
    const signR = r>=0?'+':'';
    const Qfmt = v => (Math.round(v*100)/100).toLocaleString('ja-JP');

    const R2 = isFinite(Q) ? P2*Q : NaN;
    const T0v = isFinite(T0) ? T0 : (isFinite(P)&&isFinite(Q)&&isFinite(m)? (P-(P*(1-m)))*Q : NaN);
    const T2v = isFinite(T2) ? T2 : (isFinite(P2)&&isFinite(Q)&&isFinite(m2)? (P2-(P2*(1-m2)))*Q : NaN);

    const impactBlock = [
      `・売上高（現状 → 改定後）　${isFinite(R0)?yen(R0):'—'} → ${isFinite(R2)?yen(R2):'—'}`,
      `・限界利益率（現状 → 改定後）　${isFinite(m)?(m*100).toFixed(1)+'%':'—'} → ${isFinite(m2)?(m2*100).toFixed(1)+'%':'—'}`,
      `・限界利益額（現状 → 改定後）　${isFinite(T0v)?yen(T0v):'—'} → ${isFinite(T2v)?yen(T2v):'—'}`
    ].join('\n');

    const keepBlock = (isFinite(Rreq)||isFinite(Qreq)) ? `
【同じ限界利益額を維持するために必要な水準（参考）】
・必要売上　${isFinite(Rreq)?yen(Rreq):'—'}
・必要数量　${isFinite(Qreq)?Qfmt(Qreq)+' 単位':'—'}
` : '';

    templateArea.value =
`件名：価格改定のご案内（適用開始日：＿＿＿年＿＿月＿＿日）

いつも大変お世話になっております。
＿＿＿＿（御社名）＿＿＿＿の＿＿（自社名）＿＿でございます。

このたび、誠に心苦しいお願いではございますが、下記のとおり価格改定を実施させていただきたく存じます。

【改定内容】
・改定率　：${signR}${rPct}%　
・単価　　：${yen(P)} → ${yen(P2)}（税抜）
・対象　　：＿＿＿＿（商品・サービス名、型番 等）
・適用開始：＿＿＿年＿＿月＿＿日ご注文分より

【改定の背景】
・原材料費、物流費、人件費等の上昇が継続
・品質・供給安定・サポート体制の維持向上を優先
・内部効率化やコスト吸収の努力を続けて参りましたが、自助努力のみでは吸収が困難な水準となったため

【お取引条件の変更点】
・単価改定（上記）
・（任意）ボリュームディスカウント／セット価格／送料条件 等の見直し
・既存お見積の取扱い：有効期限内は旧価格を適用（＿＿月＿＿日まで）。以降は新価格に更新いたします。

【お客様への影響（目安）】
${impactBlock}

${keepBlock}【代替案／ご協議の選択肢】
・長期契約／定期発注による価格据置や緩和
・まとめ買い条件、仕様簡素化、納期調整 等のご提案
・運用支援／教育の無償化など、総コスト低減の取り組み

【よくあるご質問（抜粋）】
Q1. いつから適用ですか？  
A. ＿＿＿年＿＿月＿＿日ご注文（または出荷）分より適用いたします。

Q2. 見積書・価格表・ECサイトはいつ更新されますか？  
A. 適用開始日に合わせて同時更新いたします。

Q3. 既に頂いているご注文／長期案件はどうなりますか？  
A. 個別に契約条件を確認し、出来る限りご負担のない形で調整いたします。

Q4. 特別なお取引条件（ボリューム・前払い等）で緩和できますか？  
A. 可能です。担当までお気軽にご相談ください。

【お問い合わせ】
担当：＿＿＿＿　TEL：＿＿＿＿　Mail：＿＿＿＿

何卒ご理解を賜りますようお願い申し上げます。

――――――――――――――――――――――――
（社名）＿＿＿＿＿＿＿＿＿＿＿＿
（住所）＿＿＿＿＿＿＿＿＿＿＿＿
（TEL）＿＿＿＿＿＿／（Mail）＿＿＿＿＿＿
（Web）＿＿＿＿＿＿＿＿＿＿＿＿
――――――――――――――――――――――――

＜店頭掲示・見積書注記の短縮版＞
${signR}${rPct}%の価格改定を＿＿年＿＿月＿＿日より実施いたします（${yen(P)} → ${yen(P2)} 税抜）。
ご不明点は担当までお問い合わせください。`;
  }

  /* ================== 3アクション ================== */
  function buildActions(r,m){
    const list=[]; if(!isFinite(r)||!isFinite(m)){actions.innerHTML='';return;}
    if(r<0){list.push('最低受注金額・最低ロットを即日設定（無償作業の抑止）');list.push('値引きの代替：納期延長／仕様簡素化／数量条件（価格は死守）');list.push('Top10顧客の割引承認フロー導入（根拠を記録）');}
    else if(r>0){list.push('主要顧客へ30日前告知：改定率・適用日・背景を明文化');list.push('まとめ買い・長期契約等の代替案で軟着陸');list.push('見積・価格表・EC・店頭の同時更新（チェックリスト運用）');}
    else{list.push('商品別の限界利益率を棚卸し：下位20%の値付け/条件見直し');list.push('割引上限1%/案件・累計3%/月のレビュー制');list.push('四半期ごとに原価変動の自動転嫁シナリオ作成');}
    actions.innerHTML=list.map(x=>`<li>${x}</li>`).join('');
  }

  /* ================== 入力取得 / 再計算 ================== */
  function getInputs(){
    const P=toNum(price.value);
    let m=null,C=null;
    if(costMode==='cost'){ const Cval=toNum(cost.value); if(isFinite(P)&&isFinite(Cval)&&P>0&&Cval>=0&&Cval<=P){ C=Cval; m=(P-C)/P; } }
    else{ const mr=toNum(mrate.value); if(isFinite(P)&&isFinite(mr)&&P>0&&mr>=0&&mr<100){ m=mr/100; C=P*(1-m); } }

    let Q=null,R0=null;
    if(volMode==='qty'){ const Qv=toNum(qty.value); if(isFinite(P)&&isFinite(Qv)&&P>0&&Qv>=0){ Q=Qv; R0=P*Q; } }
    else{ const Rv=toNum(revenue.value); if(isFinite(P)&&isFinite(Rv)&&P>0&&Rv>=0){ R0=Rv; Q=R0/P; } }

    // 値改定率（手入力優先・途中入力は保持）
    let r=NaN, P2=NaN;
    if(chgMode==='rate'){
      const raw=String(chgPct.value).trim().replace(/[％%]/g,'');
      const partial=/^-?$|^-?\d+\.?$/.test(raw);
      if(!partial){ const num=parseFloat(raw); if(isFinite(num)) r=clamp(num,-70,70)/100; }
      if(isFinite(P)&&isFinite(r)) P2=P*(1+r);
    } else {
      const A=toNum(chgAbs.value);
      if(isFinite(P)&&isFinite(A)&&P>0){ P2=A; r=P2/P-1; }
    }
    return {P,C,m,Q,R0,r,P2};
  }

  function compute(){
    updateRanges();

    const {P,C,m,Q,R0,r,P2}=getInputs();

    // STEP1クイック
    if(isFinite(P)&&isFinite(C)&&P>0&&C>=0&&C<=P){
      statM.classList.remove('hide'); stat_m_val.textContent=pct((P-C)/P);
      const Qv = isFinite(Q) ? Q : (isFinite(R0)&&isFinite(P)?R0/P:NaN);
      if(isFinite(Qv)){
        const T0=(P-C)*Qv; statT.classList.remove('hide'); stat_t_val.textContent=yen(T0);
        const Rv0=P*Qv; statR.classList.remove('hide'); stat_r_val.textContent=yen(Rv0);
      }else{ statT.classList.add('hide'); statR.classList.add('hide'); stat_t_val.textContent='—'; stat_r_val.textContent='—'; }
    }else{
      [statM,statT,statR].forEach(x=>x.classList.add('hide'));
      stat_m_val.textContent='—'; stat_t_val.textContent='—'; stat_r_val.textContent='—';
    }

    // 改定後単価
    kpi_price2.textContent = isFinite(P2)?yen(P2):'—';

    // 率↔額 同期
    if(chgMode==='rate' && isFinite(P) && isFinite(r)){
      const P2s=P*(1+r);
      const cl = clamp(P2s, Number(chgAbsRange.min), Number(chgAbsRange.max));
      chgAbs.value = Math.round(cl).toLocaleString('ja-JP'); chgAbsRange.value=cl;
    }
    if(chgMode==='abs' && isFinite(P) && isFinite(P2)){
      const rCalc=(P2/P-1)*100;
      chgRange.value=rCalc.toFixed(1);
      if(document.activeElement!==chgPct){ chgPct.value=rCalc.toFixed(1); }
    }

    // 右側初期化＋現状グラフ
    [kpi_m2,kpi_T2,kpi_reqRev,kpi_reqRevDiff,kpi_reqQty,kpi_reqQtyDiff,delta_m,delta_T].forEach(el=>{el.textContent = el.id.includes('delta')?'現状比 —':'—';});
    kpi_rev2.textContent='—'; kpi_rev2diff.textContent='現状比 —';
    dangerMsg.classList.add('hide');

    const Qv = isFinite(Q)?Q:(isFinite(R0)&&isFinite(P)?R0/P:NaN);
    const Rv0 = isFinite(P)&&isFinite(Qv)?P*Qv:NaN;

    drawPairBar(revChart, Rv0, NaN, true);
    drawPairBar(qtyChart, Qv, NaN, false);

    if(!(isFinite(P)&&isFinite(C)&&isFinite(P2)&&isFinite(Qv))){ 
      safetyBar.style.width='0%'; sensBody.innerHTML=''; actions.innerHTML=''; templateArea.value='';
      return; 
    }

    const CM=P-C, CM2=P2-C, m2=CM2/P2, rEff=(P2/P-1);
    const T0 = CM*Qv; const T2 = CM2*Qv;

    // 改定後売上高（現状比）
    const R2 = P2*Qv;
    kpi_rev2.textContent = yen(R2);
    if(isFinite(Rv0)) kpi_rev2diff.textContent = '現状比 ' + (R2-Rv0>=0?'+':'') + yen(R2 - Rv0);

    safetyGauge(m,rEff);

    kpi_m2.textContent = pct(m2);
    const dm = (m2 - m)*100; delta_m.textContent = '現状比 ' + (dm>=0?'+':'') + dm.toFixed(1) + 'pt';
    kpi_T2.textContent = yen(T2);
    const dT = T2 - T0; delta_T.textContent = '現状比 ' + (dT>=0?'+':'') + yen(dT);

    if(m2<=0||!isFinite(m2)){ dangerMsg.classList.remove('hide'); dangerMsg.textContent='警告：この値引き率では限界利益が0以下（原価割れ）です。'; }

    // 同じ限界利益額を維持するための必要指標
    let Qreq,Rreq,dQ,dR;
    if(CM2>0){ Qreq=T0/CM2; Rreq=P2*Qreq; dQ=Qreq-Qv; dR=Rreq-Rv0; }

    if(isFinite(Rreq)){
      kpi_reqRev.textContent=yen(Rreq);
      const ratioR=Rv0>0?(Rreq/Rv0-1):0;
      kpi_reqRevDiff.textContent=(ratioR>=0?'現状比 +':'現状比 ')+(ratioR*100).toFixed(1)+'% （差額 '+yen(dR)+'）';
    }
    if(isFinite(Qreq)){
      kpi_reqQty.textContent=(Math.round(Qreq*100)/100).toLocaleString('ja-JP')+' 単位';
      const ratioQ=Qv>0?(Qreq/Qv-1):0, sign=ratioQ>=0?'+':'';
      kpi_reqQtyDiff.textContent=`現状比 ${sign}${(ratioQ*100).toFixed(1)}% （差分 ${(Math.round(dQ*100)/100).toLocaleString('ja-JP')} 単位）`;
    }

    // グラフ最終描画
    drawPairBar(revChart, Rv0, Rreq, true);
    drawPairBar(qtyChart, Qv, Qreq, false);

    buildSensitivity({P,C,m,Q:Qv,R0:Rv0},[-10,-5,-1,1,5,10]);
    buildActions(rEff,m);
    buildTemplate({r:rEff,P,P2,R0:Rv0,Rreq,Q:Qv,Qreq,m,m2,T0,T2});
  }

  /* ================== 入出力同期 ================== */
  const bind = (rangeEl,inputEl,dec=null)=>{
    rangeEl.addEventListener('input',()=>{const v=Number(rangeEl.value); inputEl.value=dec===0?Math.round(v).toLocaleString('ja-JP'):v.toLocaleString('ja-JP'); compute();});
    inputEl.addEventListener('input',()=>{
      if(inputEl.value===''){ compute(); return; }
      comma(inputEl,dec); const v=toNum(inputEl.value);
      if(isFinite(v)) rangeEl.value=clamp(v, Number(rangeEl.min), Number(rangeEl.max));
      compute();
    });
  };
  bind(costRange,cost);
  bind(mrateRange,mrate);
  bind(qtyRange,qty,0);
  bind(revRange,revenue);
  bind(chgAbsRange,chgAbs);

  // 値改定率テキスト：リアルタイム
  function onRateTextInput(){
    const raw = chgPct.value.trim().replace(/[％%]/g,'');
    if (/^-?$|^-?\d+\.?$/.test(raw)) { compute(); return; }
    const num = parseFloat(raw);
    if (isFinite(num)){
      const cl = clamp(num, -70, 70);
      chgRange.value = cl.toFixed(1);
    }
    compute();
  }
  function onRateTextCommit(){
    const num = parseFloat(String(chgPct.value).replace(/[,%％]/g,''));
    if (isFinite(num)){
      const cl = clamp(num, -70, 70);
      chgPct.value   = cl.toFixed(1);
      chgRange.value = cl.toFixed(1);
    }
    compute();
  }
  chgPct.addEventListener('input', onRateTextInput);
  chgPct.addEventListener('change', onRateTextCommit);
  chgPct.addEventListener('blur', onRateTextCommit);
  chgRange.addEventListener('input',()=>{ if(document.activeElement!==chgPct){ chgPct.value=Number(chgRange.value).toFixed(1); } compute(); });

  price.addEventListener('input',()=>{ if(price.value!=='') comma(price); updateRanges(); compute(); });

  function setCostMode(mode){ costMode=mode;
    if(mode==='cost'){ chipCost.classList.add('active'); chipMrate.classList.remove('active'); blockCost.classList.remove('hide'); blockMrate.classList.add('hide'); }
    else{ chipMrate.classList.add('active'); chipCost.classList.remove('active'); blockCost.classList.add('hide'); blockMrate.classList.remove('hide'); }
    updateRanges(); compute();
  }
  function setVolMode(mode){ volMode=mode;
    if(mode==='qty'){ chipQty.classList.add('active'); chipRev.classList.remove('active'); blockQty.classList.remove('hide'); blockRev.classList.add('hide'); }
    else{ chipRev.classList.add('active'); chipQty.classList.remove('active'); blockQty.classList.add('hide'); blockRev.classList.remove('hide'); }
    updateRanges(); compute();
  }
  function setChgMode(mode){ chgMode=mode;
    if(mode==='rate'){ chipRate.classList.add('active'); chipAbs.classList.remove('active'); document.getElementById('rateInputs').classList.remove('hide'); document.getElementById('absInputs').classList.add('hide'); }
    else{ chipAbs.classList.add('active'); chipRate.classList.remove('active'); document.getElementById('rateInputs').classList.add('hide'); document.getElementById('absInputs').classList.remove('hide'); if(!chgAbs.value){ const P=toNum(price.value); if(isFinite(P)&&P>0){ chgAbs.value=Math.round(P).toLocaleString('ja-JP'); } } }
    updateRanges(); compute();
  }

  chipCost.addEventListener('click',()=>setCostMode('cost'));
  chipMrate.addEventListener('click',()=>setCostMode('mrate'));
  chipQty.addEventListener('click',()=>setVolMode('qty'));
  chipRev.addEventListener('click',()=>setVolMode('rev'));
  chipRate.addEventListener('click',()=>setChgMode('rate'));
  chipAbs.addEventListener('click',()=>setChgMode('abs'));

  document.getElementById('sampleBtn').addEventListener('click',()=>{
    setCostMode('cost'); setVolMode('qty'); setChgMode('rate');
    price.value='1,200'; cost.value='720'; qty.value='1,000';
    chgRange.value='-5.0'; chgPct.value='-5.0'; chgAbs.value='';
    updateRanges(); costRange.value=toNum(cost.value); qtyRange.value=toNum(qty.value); compute();
  });
  document.getElementById('resetBtn').addEventListener('click',()=>{
    [price,cost,mrate,qty,revenue,chgPct,chgAbs].forEach(el=>el.value='');
    chgRange.value='0.0'; setCostMode('cost'); setVolMode('qty'); setChgMode('rate'); updateRanges(); compute();
  });

  document.getElementById('printBtn').addEventListener('click',()=>{ try{ window.print(); }catch(e){} });
  document.getElementById('copyResultBtn').addEventListener('click',()=>{
    const text = document.getElementById('resultCard').innerText || '';
    if(navigator.clipboard){ navigator.clipboard.writeText(text); }
  });
  document.getElementById('copyTemplateBtn').addEventListener('click',()=>{
    if(navigator.clipboard){ navigator.clipboard.writeText(templateArea.value||''); }
  });

  /* ================== フッター（年 & 最終更新日） ================== */
  try{
    document.getElementById('cpy-year').textContent = String(new Date().getFullYear());
    const ld = new Date(document.lastModified);
    const z = n => String(n).padStart(2,'0');
    const ymd = isNaN(ld.getTime()) ? '' : `${ld.getFullYear()}-${z(ld.getMonth()+1)}-${z(ld.getDate())}`;
    document.getElementById('last-updated-date').textContent = ymd;
  }catch(e){}

  /* ================== チュートリアル ================== */
  const helpBtn = document.getElementById('helpBtn');
  const tourOverlay = document.getElementById('tourOverlay');
  const tourSpot = document.getElementById('tourSpot');
  const tourBox = document.getElementById('tourBox');
  const tourTitle = document.getElementById('tourTitle');
  const tourText = document.getElementById('tourText');
  const tourStep = document.getElementById('tourStep');
  const tourNext = document.getElementById('tourNext');
  const tourBack = document.getElementById('tourBack');
  const tourEnd = document.getElementById('tourEnd');
  const tourDemoBtn = document.getElementById('tourDemoBtn');

  const steps = [
    { el: '.header', title:'ようこそ', text:'このツールは、値引き/値上げが「限界利益」に与える影響を可視化し、現場で意思決定できる形に落とし込みます。数分で使い方を確認しましょう。', align:'bottom' },
    { el: '#price', title:'1. 現在の単価', text:'まず「現在の単価」を税抜で入力します。入力と同時にコンマ整形・範囲調整が行われます。', align:'bottom',
      ensure:()=>{} },
    { el: '#chipsCostGroup', title:'2. コストの入力方法', text:'原価（変動費）か、限界利益率のどちらかで入力方法を選びます。選択に応じて下の入力欄が切り替わります。', align:'bottom',
      ensure:()=>setCostMode('cost') },
    { el: '#blockCost', title:'2-1. 原価（変動費）', text:'「1単位あたり原価」を入力（スライダー/直接入力）。原価は「現在の単価」を上限として自動クランプされます。', align:'right',
      ensure:()=>setCostMode('cost') },
    { el: '#chipsVolGroup', title:'3. ボリュームの入力', text:'数量または売上高のいずれかで入力します。こちらもスライダー/直接入力に対応。', align:'bottom',
      ensure:()=>setVolMode('qty') },
    { el: '#blockQty', title:'3-1. 数量', text:'月間販売数量を入力します（上限10,000）。売上高で入力したい場合は「売上高」を選択してください。', align:'right',
      ensure:()=>setVolMode('qty') },
    { el: '#chipsChgGroup', title:'4. 改定方法の選択', text:'値改定は「改定率」または「改定後単価」を選べます。どちらもスライダー/直接入力に対応し、相互に同期します。', align:'bottom',
      ensure:()=>setChgMode('rate') },
    { el: '#rateInputs', title:'4-1. 値改定率', text:'キーボード入力でもリアルタイムに再計算。負号・小数1位までOK（-70%〜+70%）。', align:'right',
      ensure:()=>setChgMode('rate') },
    { el: '#resultCard', title:'5. 結果の見方', text:'「改定後単価」「改定後売上高」「限界利益率/額（改定後）」と、その現状比の差分が表示されます。原価割れは警告でお知らせ。', align:'top' },
    { el: '#graphCard', title:'6. グラフ', text:'現状と「同じ限界利益額を維持するための必要水準」をバーで比較。緑＝必要が減る（楽）、赤＝必要が増える（厳）。', align:'top' },
    { el: '#sensCard', title:'7. 感度分析', text:'±1/±5/±10%の改定シナリオに対して、必要売上・必要数量がどう変わるかを一覧で把握できます。', align:'top' },
    { el: '#templateCard', title:'8. 告知テンプレ', text:'顧客向けの告知文を自動生成。必要に応じてコピーボタンで流用し、印刷も可能です。', align:'top' },
    { el: '.mk-mini', title:'最後に', text:'フッターにはライセンス・利用条件・最終更新日（自動）が表示されます。いつでも右上「❓チュートリアル」から再確認できます。', align:'top' }
  ];

  let cur = 0, tourActive = false;
  function scrollToEl(el){
    el.scrollIntoView({behavior:'smooth',block:'center',inline:'center'});
  }
  function place(step){
    const el = document.querySelector(step.el);
    if(!el){ return; }
    const r = el.getBoundingClientRect();
    const pad = 6;
    // ハイライト
    tourSpot.style.left = (r.left - pad) + 'px';
    tourSpot.style.top = (r.top - pad) + 'px';
    tourSpot.style.width = (r.width + pad*2) + 'px';
    tourSpot.style.height = (r.height + pad*2) + 'px';

    // テキスト
    tourTitle.textContent = step.title || '';
    tourText.textContent = step.text || '';
    tourStep.textContent = (cur+1) + ' / ' + steps.length;

    // ツールチップ配置
    const box = tourBox.getBoundingClientRect(); // 直前の大きさ
    let bx = r.left, by = r.bottom + 12; // デフォは下
    if(step.align==='top'){ by = r.top - (box.height + 12); }
    if(step.align==='right'){ bx = r.right + 12; by = r.top; }
    if(step.align==='left'){ bx = r.left - (Math.min(box.width, 360) + 12); by = r.top; }
    // 画面内に収める
    const vw = window.innerWidth, vh = window.innerHeight;
    bx = Math.max(12, Math.min(bx, vw - (box.width + 12)));
    by = Math.max(12, Math.min(by, vh - (box.height + 12)));
    tourBox.style.left = bx + 'px';
    tourBox.style.top = by + 'px';

    // ボタン状態
    tourBack.disabled = cur===0;
    tourNext.textContent = (cur===steps.length-1)?'完了':'次へ';
  }
  function show(i){
    cur = Math.max(0, Math.min(i, steps.length-1));
    const s = steps[cur];
    if(s.ensure) s.ensure();
    const target = document.querySelector(s.el);
    if(target){ scrollToEl(target); setTimeout(()=>place(s), 260); }
    else{ place(s); }
  }
  function startTutorial(){
    tourActive = true;
    tourOverlay.classList.add('active');
    tourOverlay.setAttribute('aria-hidden','false');
    show(0);
  }
  function endTutorial(){
    tourActive = false;
    tourOverlay.classList.remove('active');
    tourOverlay.setAttribute('aria-hidden','true');
  }

  helpBtn.addEventListener('click', startTutorial);
  tourNext.addEventListener('click', ()=>{ if(cur<steps.length-1){ show(cur+1); } else { endTutorial(); } });
  tourBack.addEventListener('click', ()=> show(cur-1));
  tourEnd.addEventListener('click', endTutorial);
  tourDemoBtn.addEventListener('click', ()=>{ document.getElementById('sampleBtn').click(); });

  window.addEventListener('resize', ()=>{ if(tourActive) place(steps[cur]); });
  window.addEventListener('scroll', ()=>{ if(tourActive) place(steps[cur]); });
  window.addEventListener('keydown', (e)=>{
    if(!tourActive) return;
    if(e.key==='Escape'){ endTutorial(); }
    if(e.key==='ArrowRight'){ tourNext.click(); }
    if(e.key==='ArrowLeft'){ tourBack.click(); }
  });

  // 初期配置
  relocateActions();
  updateRanges();
  compute();
})();
</script>
</body>
</html>