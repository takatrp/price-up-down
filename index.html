<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>価格改定検討ツール r17</title>

<!-- Favicon -->
<link rel="icon" type="image/png" sizes="192x192" href="favicon192192.png">
<link rel="apple-touch-icon" sizes="192x192" href="favicon192192.png">
<link rel="shortcut icon" href="favicon192192.png">

<style>
  :root{--brand:#578899;--ink:#1f2937;--muted:#6b7280;--bg:#f7fafc;--ok:#10b981;--warn:#ef4444;--card:#fff;--grid:#e5e7eb;}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic","Meiryo",sans-serif;}
  .wrap{max-width:1100px;margin:0 auto;padding:12px}

  /* ヘッダー */
  .header{display:flex;align-items:center;gap:12px;margin:6px 0 8px}
  .logo{height:48px;width:auto;object-fit:contain;border-radius:8px}
  .title{font-weight:800;font-size:1.25rem;color:#0f172a}
  .badge{display:inline-block;padding:3px 8px;border-radius:8px;background:#eef6fa;color:#578899;font-weight:700;font-size:.82rem;margin-left:6px}
  .sub{font-size:.85rem;color:var(--muted);margin:0 0 8px}

  /* カード */
  .card{background:var(--card);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:12px}
  .pill{display:inline-block;background:rgba(87,136,153,.1);color:var(--brand);font-weight:700;border-radius:999px;padding:5px 9px;font-size:.8rem}
  .cardHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}

  /* 入力 */
  label{display:block;font-size:.86rem;color:#374151;margin:6px 0 6px;font-weight:600}
  input[type="text"],textarea{width:100%;box-sizing:border-box;border:1px solid #e5e7eb;border-radius:10px;padding:10px;font-size:1rem;background:#fff;outline:none}
  input:focus,textarea:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(87,136,153,.15)}
  .primaryInput{border:2px solid var(--brand)!important;background:#f3f8fb}
  input::placeholder{color:#c7ccd3} /* 例）を薄めに */
  .hint{font-size:.76rem;color:var(--muted);margin-top:4px}

  /* ボタン */
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;background:var(--brand);color:#fff;border:none;border-radius:10px;padding:10px 12px;font-weight:700;font-size:.92rem}
  .btn.alt{background:#e5e7eb;color:#111827}
  .btn.sm{padding:6px 8px;font-size:.82rem;border-radius:8px}
  .miniActions{display:flex;gap:6px}

  /* チップ */
  .chipGroup{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px;margin-bottom:2px}
  .chip{border:1px solid #d1d5db;background:#fff;border-radius:999px;padding:6px 10px;font-size:.85rem;font-weight:700;color:#374151;cursor:pointer}
  .chip.active{border-color:var(--brand);background:#eef6fa;color:#0f172a}

  /* スライダー */
  .slider{display:flex;align-items:center;gap:8px;margin-top:6px}
  input[type="range"]{width:100%}

  /* かんたん統計（STEP1内） */
  .inlineStats{display:flex;gap:12px;flex-wrap:wrap;margin-top:6px}
  .stat{font-size:.9rem;color:#374151;background:#f0f4f8;border:1px solid #e5e7eb;padding:6px 10px;border-radius:8px}
  .hide{display:none}

  /* KPI/カード */
  .kpi{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
  .kpi .item{flex:1 1 160px;min-width:160px;background:#fff;border:1px solid #eef2f7;border-radius:10px;padding:10px}
  .kpi .lbl{font-size:.76rem;color:#6b7280}
  .kpi .val{font-size:1.2rem;font-weight:800;margin-top:2px}
  .kpi .val.ok{color:var(--ok)} .kpi .val.warn{color:var(--warn)}
  .danger{color:var(--warn);font-weight:700;margin-top:8px}

  /* サブカード（改定後＋現状比） */
  .subgrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;margin-top:6px}
  .subcard{border:1px solid #eef2f7;border-radius:10px;padding:10px;background:#fff}
  .subttl{font-size:.82rem;color:#6b7280;font-weight:700;margin-bottom:6px}
  .bigVal{font-size:1.25rem;font-weight:800}
  .delta{font-size:.82rem;color:#6b7280;margin-top:4px}

  /* グラフ */
  .chartWrap{display:flex;flex-direction:column;gap:8px}
  .chart{width:100%;height:116px;border:1px solid var(--grid);border-radius:10px;padding:8px;box-sizing:border-box}
  svg{width:100%;height:100%}
  .legend{display:flex;gap:8px;align-items:center;font-size:.82rem;color:#374151;margin-top:4px}
  .lg{display:inline-block;width:14px;height:10px;border-radius:3px}
  .lg.cur{background:var(--brand)} .lg.req.ok{background:#10b981} .lg.req.warn{background:#ef4444}

  /* レイアウト：デフォ1カラム／横向きは2カラム */
  .dashboard{display:block}
  .colL,.colR{display:flex;flex-direction:column;gap:10px}
  @media (orientation:landscape){
    .dashboard{display:grid;grid-template-columns:minmax(300px,42%) 1fr;gap:10px;align-items:start}
  }
  @media (min-width:1024px){
    .dashboard{display:grid;grid-template-columns:380px 1fr;gap:10px;align-items:start}
  }

  .credit{color:#374151;font-size:.84rem;text-align:center;margin:16px 0 8px}
  .credit a{color:#374151;text-decoration:underline}
  .note{font-size:.8rem;color:#6b7280;text-align:center;margin-bottom:24px}
  @media print{.slider input[type="range"],button{display:none !important}.wrap{max-width:900px}}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <img src="ロゴ.jpg" alt="ロゴ" class="logo">
    <div class="title">価格改定検討ツール <span class="badge">r17</span></div>
  </div>
  <div class="sub">値引き/値上げの「現場インパクト」を<b>限界利益</b>で数値化＆グラフ化。</div>

  <div class="dashboard">
    <!-- 左 -->
    <div class="colL">
      <div class="card step1">
        <div class="cardHeader">
          <div class="pill">STEP 1：現状を入力</div>
          <div class="miniActions">
            <button class="btn alt sm" id="sampleBtn" type="button">サンプル読込</button>
            <button class="btn alt sm" id="resetBtn" type="button">リセット</button>
          </div>
        </div>

        <label>現在の単価（税抜）</label>
        <input type="text" id="price" class="primaryInput" inputmode="decimal" placeholder="例）1,200" />

        <div class="chipGroup" aria-label="コスト入力方法">
          <button class="chip active" id="chipCost" type="button">原価（変動費）</button>
          <button class="chip" id="chipMrate" type="button">限界利益率</button>
        </div>
        <div id="blockCost">
          <label>1単位あたり原価（変動費）</label>
          <div class="slider">
            <input type="range" id="costRange" min="0" max="100000" step="1" />
            <input type="text" id="cost" inputmode="decimal" placeholder="例）720" />
          </div>
        </div>
        <div id="blockMrate" class="hide">
          <label>限界利益率（%）</label>
          <div class="slider">
            <input type="range" id="mrateRange" min="0" max="90" step="0.1" />
            <input type="text" id="mrate" inputmode="decimal" placeholder="例）40" />
            <span class="hint">%</span>
          </div>
        </div>

        <div class="chipGroup" aria-label="ボリューム入力方法">
          <button class="chip active" id="chipQty" type="button">数量</button>
          <button class="chip" id="chipRev" type="button">売上高</button>
        </div>
        <div id="blockQty">
          <label>月間販売数量（単位）</label>
          <div class="slider">
            <input type="range" id="qtyRange" min="0" max="10000" step="1" />
            <input type="text" id="qty" inputmode="numeric" placeholder="例）1,000" />
          </div>
        </div>
        <div id="blockRev" class="hide">
          <label>月間売上高（税抜）</label>
          <div class="slider">
            <input type="range" id="revRange" min="0" max="3000000" step="1000" />
            <input type="text" id="revenue" inputmode="decimal" placeholder="例）1,200,000" />
          </div>
        </div>

        <div class="hint">※固定費は扱いません（「同じ限界利益額を維持するために必要な売上/数量」を算出）。</div>

        <!-- クイック表示 -->
        <div class="inlineStats" id="inlineStats">
          <div class="stat hide" id="statM">限界利益率：<span id="stat_m_val">—</span></div>
          <div class="stat hide" id="statT">限界利益額：<span id="stat_t_val">—</span></div>
        </div>
      </div>

      <div class="card step2">
        <div class="pill">STEP 2：値改定を設定</div>

        <div class="chipGroup" aria-label="改定方法の選択">
          <button class="chip active" id="chipRate" type="button" aria-selected="true">値改定率</button>
          <button class="chip" id="chipAbs" type="button" aria-selected="false">改定後単価</button>
        </div>

        <!-- 率 -->
        <div id="rateInputs">
          <label>値改定率（%） <span class="hint">マイナス=値引き、プラス=値上げ</span></label>
          <div class="slider">
            <input type="range" id="chgRange" min="-70" max="70" step="0.1" value="0" />
            <input type="text" id="chgPct" style="width:120px" inputmode="decimal" value="0" />
            <span class="hint">%</span>
          </div>
        </div>

        <!-- 改定後単価（スライダー） -->
        <div id="absInputs" class="hide">
          <label>改定後単価（税抜）</label>
          <div class="slider">
            <input type="range" id="chgAbsRange" min="0" max="200000" step="1" />
            <input type="text" id="chgAbs" inputmode="decimal" placeholder="例）1,140" />
          </div>
        </div>

        <div class="hint" style="margin-top:6px">安全域インジケータ（値引き率が −m を超えると原価割れ）</div>
        <div style="height:8px;border-radius:999px;background:#e5e7eb;overflow:hidden"><span id="safetyBar" style="display:block;height:100%;background:linear-gradient(90deg,var(--warn),#f59e0b,var(--ok));width:0%"></span></div>
      </div>

      <div class="card actions" id="actionsCard">
        <div class="pill">今日やる3アクション</div>
        <ol id="actions" style="margin-top:6px;padding-left:20px"></ol>
      </div>
    </div>

    <!-- 右 -->
    <div class="colR">
      <div class="card result" id="resultCard">
        <div class="pill">結果</div>

        <div class="kpi" style="margin-top:6px">
          <div class="item"><div class="lbl">改定後単価</div><div class="val" id="kpi_price2">—</div></div>
        </div>

        <!-- 改定後＋現状比 -->
        <div class="subgrid">
          <div class="subcard">
            <div class="subttl">限界利益率</div>
            <div class="bigVal" id="kpi_m2">—</div>
            <div class="delta" id="delta_m">現状比 —</div>
          </div>
          <div class="subcard">
            <div class="subttl">限界利益額</div>
            <div class="bigVal" id="kpi_T2">—</div>
            <div class="delta" id="delta_T">現状比 —</div>
          </div>
        </div>

        <!-- 必要売上・数量（同じ限界利益額を維持） -->
        <div class="kpi">
          <div class="item">
            <div class="lbl">同じ限界利益額を維持するための必要売上</div>
            <div class="val" id="kpi_reqRev">—</div>
            <div class="hint" id="kpi_reqRevDiff"></div>
          </div>
          <div class="item">
            <div class="lbl">同じ限界利益額を維持するための必要数量</div>
            <div class="val" id="kpi_reqQty">—</div>
            <div class="hint" id="kpi_reqQtyDiff"></div>
          </div>
        </div>

        <div id="dangerMsg" class="danger hide"></div>
      </div>

      <div class="card graph">
        <div class="pill">グラフで確認</div>
        <div class="chartWrap">
          <div>
            <div class="hint">売上：現状 vs 必要（同じ限界利益額を維持）</div>
            <div class="chart"><svg id="revChart" viewBox="0 0 360 116" preserveAspectRatio="none"></svg></div>
            <div class="legend">
              <span class="lg cur"></span>現状
              <span class="lg req ok" id="lgRevOk" style="display:none"></span><span id="lgRevOkLbl" style="display:none">必要（下降＝楽）</span>
              <span class="lg req warn" id="lgRevWarn" style="display:none"></span><span id="lgRevWarnLbl" style="display:none">必要（上昇＝厳）</span>
            </div>
          </div>
          <div>
            <div class="hint">数量：現状 vs 必要（同じ限界利益額を維持）</div>
            <div class="chart"><svg id="qtyChart" viewBox="0 0 360 116" preserveAspectRatio="none"></svg></div>
            <div class="legend">
              <span class="lg cur"></span>現状
              <span class="lg req ok" id="lgQtyOk" style="display:none"></span><span id="lgQtyOkLbl" style="display:none">必要（下降＝楽）</span>
              <span class="lg req warn" id="lgQtyWarn" style="display:none"></span><span id="lgQtyWarnLbl" style="display:none">必要（上昇＝厳）</span>
            </div>
          </div>
        </div>
      </div>

      <div class="card sens" id="sensCard">
        <div class="pill">感度（±1/±5/±10% の値改定時）</div>
        <div class="hint">「現状と同じ限界利益額を維持するために必要な売上/数量（比較）」</div>
        <div style="overflow:auto">
          <table class="table" id="sensTable">
            <thead><tr><th>改定率</th><th>必要売上</th><th>現状比</th><th>必要数量</th><th>現状比</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card template">
        <div class="pill">顧客向け告知テンプレ（メール/店頭/見積書注記）</div>
        <textarea class="area" id="templateArea" style="min-height:120px"></textarea>
        <div class="miniActions" style="margin-top:8px">
          <button class="btn" id="copyResultBtn" type="button">結果をコピー</button>
          <button class="btn" id="copyTemplateBtn" type="button">テンプレをコピー</button>
          <button class="btn alt" id="printBtn" type="button">印刷</button>
        </div>
      </div>
    </div>
  </div>

  <div class="credit">Copyright (c) 2025 <a href="https://www.matsumoto-kaikei.or.jp/" target="_blank" rel="noopener noreferrer">税理士法人松本会計事務所</a> All Rights Reserved. / r17</div>
  <div class="note">本ツールは管理会計上の試算です。実際の価格変更は取引条件・競合状況・需要弾力性等も併せてご判断ください。</div>
</div>

<script>
(function(){
  const yen = n => isFinite(n) ? new Intl.NumberFormat('ja-JP',{style:'currency',currency:'JPY',maximumFractionDigits:0}).format(n) : '—';
  const pct = x => isFinite(x) ? (x*100).toFixed(1).replace(/\.0$/,'') + '%' : '—';
  const toNum=v=>{const s=String(v||'').replace(/,/g,'').replace(/[^\d.-]/g,'');const n=parseFloat(s);return isFinite(n)?n:NaN;}
  const clamp=(v,min,max)=>Math.min(max,Math.max(min,v));
  const comma=(el,dec=null)=>{const n=toNum(el.value);if(!isFinite(n))return;
    if(dec===0)el.value=Math.round(n).toLocaleString('ja-JP');
    else if(typeof dec==='number')el.value=n.toLocaleString('ja-JP',{minimumFractionDigits:dec,maximumFractionDigits:dec});
    else{const raw=String(el.value).replace(/,/g,'');const hasDot=raw.includes('.');el.value=hasDot?n.toLocaleString('ja-JP',{maximumFractionDigits:6}):Math.round(n).toLocaleString('ja-JP');}
  };

  let costMode='cost', volMode='qty', chgMode='rate';

  // 要素
  const price = document.getElementById('price');
  const chipCost=document.getElementById('chipCost'), chipMrate=document.getElementById('chipMrate');
  const chipQty=document.getElementById('chipQty'), chipRev=document.getElementById('chipRev');
  const chipRate=document.getElementById('chipRate'), chipAbs=document.getElementById('chipAbs');

  const blockCost=document.getElementById('blockCost'), blockMrate=document.getElementById('blockMrate');
  const blockQty=document.getElementById('blockQty'), blockRev=document.getElementById('blockRev');

  const cost=document.getElementById('cost'), costRange=document.getElementById('costRange');
  const mrate=document.getElementById('mrate'), mrateRange=document.getElementById('mrateRange');

  const qty=document.getElementById('qty'), qtyRange=document.getElementById('qtyRange');
  const revenue=document.getElementById('revenue'), revRange=document.getElementById('revRange');

  const chgRange=document.getElementById('chgRange'), chgPct=document.getElementById('chgPct');
  const chgAbs=document.getElementById('chgAbs'), chgAbsRange=document.getElementById('chgAbsRange');

  const safetyBar=document.getElementById('safetyBar');

  const kpi_price2=document.getElementById('kpi_price2');
  const kpi_m2=document.getElementById('kpi_m2');
  const kpi_T2=document.getElementById('kpi_T2');
  const delta_m=document.getElementById('delta_m');
  const delta_T=document.getElementById('delta_T');

  const kpi_reqRev=document.getElementById('kpi_reqRev');
  const kpi_reqRevDiff=document.getElementById('kpi_reqRevDiff');
  const kpi_reqQty=document.getElementById('kpi_reqQty');
  const kpi_reqQtyDiff=document.getElementById('kpi_reqQtyDiff');

  const dangerMsg=document.getElementById('dangerMsg');
  const sensBody=document.querySelector('#sensTable tbody');
  const actions=document.getElementById('actions');
  const templateArea=document.getElementById('templateArea');
  const actionsCard=document.getElementById('actionsCard');
  const sensCard=document.getElementById('sensCard');

  const statM=document.getElementById('statM'), statT=document.getElementById('statT');
  const stat_m_val=document.getElementById('stat_m_val'), stat_t_val=document.getElementById('stat_t_val');

  const revChart=document.getElementById('revChart');
  const qtyChart=document.getElementById('qtyChart');
  const lgRevOk=document.getElementById('lgRevOk');
  const lgRevOkLbl=document.getElementById('lgRevOkLbl');
  const lgRevWarn=document.getElementById('lgRevWarn');
  const lgRevWarnLbl=document.getElementById('lgRevWarnLbl');
  const lgQtyOk=document.getElementById('lgQtyOk');
  const lgQtyOkLbl=document.getElementById('lgQtyOkLbl');
  const lgQtyWarn=document.getElementById('lgQtyWarn');
  const lgQtyWarnLbl=document.getElementById('lgQtyWarnLbl');

  /* 2カラム判定：横向き or PC */
  function isTwoCol(){
    return window.matchMedia('(min-width:1024px)').matches
        || window.matchMedia('(orientation:landscape)').matches;
  }
  function relocateActions(){
    if(isTwoCol()){
      const step2=document.querySelector('.step2');
      if(actionsCard.previousElementSibling!==step2){ step2.insertAdjacentElement('afterend',actionsCard); }
    }else{
      if(actionsCard.previousElementSibling!==sensCard){ sensCard.insertAdjacentElement('afterend',actionsCard); }
    }
  }
  window.addEventListener('resize', relocateActions);

  /* 範囲設定 */
  function updateRanges(){
    const P=toNum(price.value);
    const priceOk=isFinite(P)&&P>0;

    costRange.min=0; costRange.max=priceOk?Math.floor(P):100000; costRange.step=1;
    qtyRange.min=0; qtyRange.max=10000; qtyRange.step=1;
    revRange.min=0; revRange.max=priceOk?Math.ceil(P*10000):3000000; revRange.step=1000;
    chgRange.min=-70; chgRange.max=70; chgRange.step=0.1;

    const absMax=priceOk?Math.ceil(P*2):200000;
    chgAbsRange.min=0; chgAbsRange.max=absMax; chgAbsRange.step=1;

    // 入力→レンジをクランプ（空欄は維持）
    const clampIO=(rangeEl,inputEl,dec=null)=>{
      const v=toNum(inputEl.value);
      if(isFinite(v)){
        const cl=clamp(v, Number(rangeEl.min), Number(rangeEl.max));
        if (cl!==v){ inputEl.value=dec===0?Math.round(cl).toLocaleString('ja-JP'):cl.toLocaleString('ja-JP'); }
        rangeEl.value=cl;
      }
      if(dec!==null) comma(inputEl,dec); else comma(inputEl);
    };
    clampIO(costRange,cost);
    clampIO(qtyRange,qty,0);
    clampIO(revRange,revenue);
  }

  /* SVG支援 */
  function clearSVG(svg){while(svg.firstChild)svg.removeChild(svg.firstChild);}
  function drawPairBar(svg,cur,req,isRev){
    clearSVG(svg); if(!(isFinite(cur)&&isFinite(req)))return;
    const W = svg.clientWidth || 360;      // 可変幅
    const barH=18,gap=12,left=56,right=110; // 左寄せ＋右側を広く
    const maxVal=Math.max(cur,req)*1.1||1;
    const scale=(W-left-right)/maxVal;
    const y1=22,y2=y1+barH+gap;

    // 軸
    const mk=(x1,y1,x2,y2,s='#e5e7eb')=>{const l=document.createElementNS('http://www.w3.org/2000/svg','line');l.setAttribute('x1',x1);l.setAttribute('y1',y1);l.setAttribute('x2',x2);l.setAttribute('y2',y2);l.setAttribute('stroke',s);l.setAttribute('stroke-width','1');svg.appendChild(l);};
    mk(left,y1-12,left,y2+barH+10);
    [0.25,0.5,0.75,1].forEach(p=>{const xx=left+(W-left-right)*p;mk(xx,y1-12,xx,y2+barH+10);});

    // ラベル
    const txt=(x,y,t,a='end')=>{const tx=document.createElementNS('http://www.w3.org/2000/svg','text');tx.setAttribute('x',x);tx.setAttribute('y',y);tx.setAttribute('fill','#374151');tx.setAttribute('font-size','11');tx.setAttribute('text-anchor',a);tx.textContent=t;svg.appendChild(tx);};
    txt(left-8,y1+barH-5,'現状'); txt(left-8,y2+barH-5,'必要');

    // バー
    const rect=(x,y,w,h,fill)=>{const r=document.createElementNS('http://www.w3.org/2000/svg','rect');r.setAttribute('x',x);r.setAttribute('y',y);r.setAttribute('width',w);r.setAttribute('height',h);r.setAttribute('rx','6');r.setAttribute('fill',fill);svg.appendChild(r);};
    const wCur=Math.max(2,cur*scale), wReq=Math.max(2,req*scale), up=req>cur;
    rect(left,y1,wCur,barH,'var(--brand)');
    rect(left,y2,wReq,barH, up?'var(--warn)':'var(--ok)');

    // 数値は右端固定（見切れ防止）
    const rightX = W - 8;
    const fmt=isRev?(v)=>yen(v):(v)=>(Math.round(v*100)/100).toLocaleString('ja-JP')+' 単位';
    txt(rightX,y1+barH-5,fmt(cur),'end');
    txt(rightX,y2+barH-5,fmt(req),'end');

    if(isRev){lgRevOk.style.display=up?'none':'inline-block';lgRevOkLbl.style.display=up?'none':'inline';lgRevWarn.style.display=up?'inline-block':'none';lgRevWarnLbl.style.display=up?'inline':'none';}
    else{lgQtyOk.style.display=up?'none':'inline-block';lgQtyOkLbl.style.display=up?'none':'inline';lgQtyWarn.style.display=up?'inline-block':'none';lgQtyWarnLbl.style.display=up?'inline':'none';}
  }

  function safetyGauge(m,r){
    if(!isFinite(m)||!isFinite(r)){safetyBar.style.width='0%';return;}
    const x=(r-(-m))/(0.3-(-m)); safetyBar.style.width=Math.min(100,Math.max(0,x*100)).toFixed(1)+'%';
  }

  function buildSensitivity(base,steps){
    const {P,C,Q,R0}=base, T0=(P-C)*Q; sensBody.innerHTML='';
    steps.forEach(s=>{
      const r=s/100, P2=P*(1+r), CM2=P2-C;
      let Qreq=NaN, Rreq=NaN, rr=NaN, rq=NaN;
      if(CM2>0){ Qreq=T0/CM2; Rreq=P2*Qreq; rr=R0>0?(Rreq/R0-1):NaN; rq=Q>0?(Qreq/Q-1):NaN; }
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${s>0?'+':''}${s}%</td>
        <td>${isFinite(Rreq)?yen(Rreq):'—'}</td>
        <td>${isFinite(rr)?(rr>=0?'+':'')+(rr*100).toFixed(1)+'%':'—'}</td>
        <td>${isFinite(Qreq)?(Math.round(Qreq*100)/100).toLocaleString('ja-JP')+' 単位':'—'}</td>
        <td>${isFinite(rq)?(rq>=0?'+':'')+(rq*100).toFixed(1)+'%':'—'}</td>`;
      sensBody.appendChild(tr);
    });
  }

  function buildActions(r,m){
    const list=[]; if(!isFinite(r)||!isFinite(m)){actions.innerHTML='';return;}
    if(r<0){list.push('最低受注金額・最低ロットを即日設定（無償作業の抑止）');list.push('値引きの代替：納期延長／仕様簡素化／数量条件（価格は死守）');list.push('Top10顧客の割引承認フロー導入（根拠を記録）');}
    else if(r>0){list.push('主要顧客へ30日前告知：改定率・適用日・背景を明文化');list.push('まとめ買い・長期契約等の代替案で軟着陸');list.push('見積・価格表・EC・店頭の同時更新（チェックリスト運用）');}
    else{list.push('商品別の限界利益率を棚卸し：下位20%の値付け/条件見直し');list.push('割引上限1%/案件・累計3%/月のレビュー制');list.push('四半期ごとに原価変動の自動転嫁シナリオ作成');}
    actions.innerHTML=list.map(x=>`<li>${x}</li>`).join('');
  }

  function buildTemplate({r,P,P2,R0,Rreq,Q,Qreq}){
    if(![r,P,P2,R0,Rreq,Q,Qreq].every(x=>isFinite(x))){templateArea.value='';return;}
    const rPct=(r*100).toFixed(1).replace(/\.0$/,'');
    templateArea.value=`件名：価格改定のご案内（適用開始日：＿＿＿年＿＿月＿＿日）

いつも大変お世話になっております。

【改定内容】
・改定率：${r>=0?'+':''}${rPct}%（単価 ${yen(P)} → ${yen(P2)}）
【お客様への影響（目安）】
・必要売上 ${yen(Rreq)}、必要数量 ${(Math.round(Qreq*100)/100).toLocaleString('ja-JP')}
`;
  }

  function getInputs(){
    const P=toNum(price.value);
    let m=null,C=null;
    if(costMode==='cost'){ const Cval=toNum(cost.value); if(isFinite(P)&&isFinite(Cval)&&P>0&&Cval>=0&&Cval<=P){ C=Cval; m=(P-C)/P; } }
    else{ const mr=toNum(mrate.value); if(isFinite(P)&&isFinite(mr)&&P>0&&mr>=0&&mr<100){ m=mr/100; C=P*(1-m); } }

    let Q=null,R0=null;
    if(volMode==='qty'){ const Qv=toNum(qty.value); if(isFinite(P)&&isFinite(Qv)&&P>0&&Qv>=0){ Q=Qv; R0=P*Q; } }
    else{ const Rv=toNum(revenue.value); if(isFinite(P)&&isFinite(Rv)&&P>0&&Rv>=0){ R0=Rv; Q=R0/P; } }

    let r=NaN, P2=NaN;
    if(chgMode==='rate'){ r=toNum(chgPct.value)/100; if(!isFinite(r)) r=0; if(isFinite(P)) P2=P*(1+r); }
    else{ const A=toNum(chgAbs.value); if(isFinite(P)&&isFinite(A)&&P>0){ P2=A; r=P2/P-1; } }

    return {P,C,m,Q,R0,r,P2};
  }

  function compute(){
    updateRanges();

    const {P,C,m,Q,R0,r,P2}=getInputs();

    // STEP1クイック表示
    if(isFinite(P)&&isFinite(C)&&P>0&&C>=0&&C<=P){
      statM.classList.remove('hide'); stat_m_val.textContent=pct((P-C)/P);
      if(isFinite(Q)||isFinite(R0)){
        const Qv = isFinite(Q) ? Q : (R0/P);
        const T0 = (P-C)*Qv;
        statT.classList.remove('hide'); stat_t_val.textContent=yen(T0);
      }else{ statT.classList.add('hide'); stat_t_val.textContent='—'; }
    }else{
      statM.classList.add('hide'); statT.classList.add('hide');
      stat_m_val.textContent='—'; stat_t_val.textContent='—';
    }

    // 単価表示
    kpi_price2.textContent = isFinite(P2)?yen(P2):'—';

    // 率↔額 同期
    if(chgMode==='rate' && isFinite(P2)){
      const cl = clamp(P2, Number(chgAbsRange.min), Number(chgAbsRange.max));
      chgAbs.value = Math.round(cl).toLocaleString('ja-JP'); chgAbsRange.value=cl;
    }
    if(chgMode==='abs' && isFinite(P) && isFinite(P2)){
      const rCalc=(P2/P-1)*100; const clPct = clamp(rCalc, Number(chgRange.min), Number(chgRange.max));
      chgRange.value=clPct.toFixed(1); // 0.1刻み
      // テキストはフォーマットしすぎない（入力を尊重）
      if(document.activeElement!==chgPct){ chgPct.value=Number(clPct).toFixed(1).replace(/\.0$/,'0'); }
    }

    // 初期化
    [kpi_m2,kpi_T2,kpi_reqRev,kpi_reqRevDiff,kpi_reqQty,kpi_reqQtyDiff,delta_m,delta_T].forEach(el=>{el.textContent = el.id.includes('delta')?'現状比 —':'—';});
    dangerMsg.classList.add('hide'); clearSVG(revChart); clearSVG(qtyChart);
    [lgRevOk,lgRevOkLbl,lgRevWarn,lgRevWarnLbl,lgQtyOk,lgQtyOkLbl,lgQtyWarn,lgQtyWarnLbl].forEach(x=>x.style.display='none');

    if(!(isFinite(P)&&isFinite(C)&&isFinite(m)&&P>0&&C>=0&&C<=P&&isFinite(P2))){
      safetyBar.style.width='0%'; sensBody.innerHTML=''; actions.innerHTML=''; templateArea.value='';
      return;
    }

    const Qv = isFinite(Q)?Q:(isFinite(R0)?R0/P:NaN);
    const Rv0 = isFinite(R0)?R0:(isFinite(Q)?P*Q:NaN);
    if(!(isFinite(Qv)&&isFinite(Rv0))){ safetyBar.style.width='0%'; return; }

    const CM=P-C, CM2=P2-C, m2=CM2/P2, rEff=(P2/P-1);
    const T0 = CM*Qv; const T2 = CM2*Qv;

    safetyGauge(m,rEff);

    // 改定後＋現状比
    kpi_m2.textContent = pct(m2);
    const dm = (m2 - m)*100; delta_m.textContent = '現状比 ' + (dm>=0?'+':'') + dm.toFixed(1) + 'pt';
    kpi_T2.textContent = yen(T2);
    const dT = T2 - T0; delta_T.textContent = '現状比 ' + (dT>=0?'+':'') + yen(dT);

    if(m2<=0||!isFinite(m2)){ dangerMsg.classList.remove('hide'); dangerMsg.textContent='警告：この値引き率では限界利益が0以下（原価割れ）です。'; }

    // 「同じ限界利益額を維持」指標
    let Qreq,Rreq,dQ,dR;
    if(CM2>0){ Qreq=T0/CM2; Rreq=P2*Qreq; dQ=Qreq-Qv; dR=Rreq-Rv0; }

    if(isFinite(Rreq)){
      kpi_reqRev.textContent=yen(Rreq);
      const ratioR=Rv0>0?(Rreq/Rv0-1):0;
      kpi_reqRevDiff.textContent=(ratioR>=0?'現状比 +':'現状比 ')+(ratioR*100).toFixed(1)+'% （差額 '+yen(dR)+'）';
      kpi_reqRev.classList.toggle('ok',ratioR<=0); kpi_reqRev.classList.toggle('warn',ratioR>0&&P2<P);
    }
    if(isFinite(Qreq)){
      kpi_reqQty.textContent=(Math.round(Qreq*100)/100).toLocaleString('ja-JP')+' 単位';
      const ratioQ=Qv>0?(Qreq/Qv-1):0, sign=ratioQ>=0?'+':'';
      kpi_reqQtyDiff.textContent=`現状比 ${sign}${(ratioQ*100).toFixed(1)}% （差分 ${(Math.round(dQ*100)/100).toLocaleString('ja-JP')} 単位）`;
      kpi_reqQty.classList.toggle('ok',ratioQ<=0); kpi_reqQty.classList.toggle('warn',ratioQ>0&&P2<P);
    }

    drawPairBar(revChart,Rv0,Rreq,true);
    drawPairBar(qtyChart,Qv,Qreq,false);
    buildSensitivity({P,C,m,Q:Qv,R0:Rv0},[-10,-5,-1,1,5,10]);
    buildActions(rEff,m);
    buildTemplate({r:rEff,P,P2,R0:Rv0,Rreq,Q:Qv,Qreq});
  }

  /* スライダー⇔テキスト同期 */
  const bind = (rangeEl,inputEl,dec=null)=>{
    rangeEl.addEventListener('input',()=>{const v=Number(rangeEl.value); inputEl.value=dec===0?Math.round(v).toLocaleString('ja-JP'):v.toLocaleString('ja-JP'); compute();});
    inputEl.addEventListener('input',()=>{
      if(inputEl===chgPct){ // パーセントは自由入力（-, 小数）を許容
        const raw=inputEl.value.trim();
        const num=parseFloat(raw);
        if(isFinite(num)){ const cl=clamp(num, -70, 70); chgRange.value=cl.toFixed(1); }
        compute(); return;
      }
      if(inputEl.value===''){ compute(); return; }
      comma(inputEl,dec); const v=toNum(inputEl.value);
      if(isFinite(v)) rangeEl.value=clamp(v, Number(rangeEl.min), Number(rangeEl.max));
      compute();
    });
    if(inputEl===chgPct){
      inputEl.addEventListener('blur',()=>{
        const num=parseFloat(inputEl.value);
        if(isFinite(num)){ const cl=clamp(num,-70,70); inputEl.value=cl.toFixed(1); chgRange.value=cl.toFixed(1); compute(); }
      });
    }
  };
  bind(costRange,cost);
  bind(mrateRange,mrate);
  bind(qtyRange,qty,0);
  bind(revRange,revenue);
  bind(chgAbsRange,chgAbs);

  chgRange.addEventListener('input',()=>{ chgPct.value=Number(chgRange.value).toFixed(1); compute(); });

  price.addEventListener('input',()=>{ if(price.value!=='') comma(price); updateRanges(); compute(); });

  function setCostMode(mode){ costMode=mode;
    if(mode==='cost'){ chipCost.classList.add('active'); chipMrate.classList.remove('active'); blockCost.classList.remove('hide'); blockMrate.classList.add('hide'); }
    else{ chipMrate.classList.add('active'); chipCost.classList.remove('active'); blockCost.classList.add('hide'); blockMrate.classList.remove('hide'); }
    updateRanges(); compute();
  }
  function setVolMode(mode){ volMode=mode;
    if(mode==='qty'){ chipQty.classList.add('active'); chipRev.classList.remove('active'); blockQty.classList.remove('hide'); blockRev.classList.add('hide'); }
    else{ chipRev.classList.add('active'); chipQty.classList.remove('active'); blockQty.classList.add('hide'); blockRev.classList.remove('hide'); }
    updateRanges(); compute();
  }
  function setChgMode(mode){ chgMode=mode;
    if(mode==='rate'){ chipRate.classList.add('active'); chipAbs.classList.remove('active'); document.getElementById('rateInputs').classList.remove('hide'); document.getElementById('absInputs').classList.add('hide'); }
    else{ chipAbs.classList.add('active'); chipRate.classList.remove('active'); document.getElementById('rateInputs').classList.add('hide'); document.getElementById('absInputs').classList.remove('hide'); if(!chgAbs.value){ const P=toNum(price.value); if(isFinite(P)&&P>0){ chgAbs.value=Math.round(P).toLocaleString('ja-JP'); } } }
    updateRanges(); compute();
  }

  chipCost.addEventListener('click',()=>setCostMode('cost'));
  chipMrate.addEventListener('click',()=>setCostMode('mrate'));
  chipQty.addEventListener('click',()=>setVolMode('qty'));
  chipRev.addEventListener('click',()=>setVolMode('rev'));
  chipRate.addEventListener('click',()=>setChgMode('rate'));
  chipAbs.addEventListener('click',()=>setChgMode('abs'));

  document.getElementById('sampleBtn').addEventListener('click',()=>{
    setCostMode('cost'); setVolMode('qty'); setChgMode('rate');
    price.value='1,200'; cost.value='720'; qty.value='1,000';
    chgRange.value='-5.0'; chgPct.value='-5.0'; chgAbs.value='';
    updateRanges(); costRange.value=toNum(cost.value); qtyRange.value=toNum(qty.value); compute();
  });
  document.getElementById('resetBtn').addEventListener('click',()=>{
    [price,cost,mrate,qty,revenue,chgPct,chgAbs].forEach(el=>el.value='');
    chgRange.value='0.0'; setCostMode('cost'); setVolMode('qty'); setChgMode('rate'); updateRanges(); compute();
  });

  document.getElementById('printBtn').addEventListener('click',()=>{ try{ window.print(); }catch(e){} });

  relocateActions();
  updateRanges();
  compute();
})();
</script>
</body>
</html>
